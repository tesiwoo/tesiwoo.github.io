---
title: slice-cluster
createTime: 2025/07/04 18:05:52
permalink: /db/8has9shw/
---
# 切片集群
切片集群：也叫分片集群，就是指启动多个实例组成一个集群，然后按照一定的规则，把收到的数据划分成多份，每一份有一个实例来保存。


> 为了保存大量数据，可以使用大内存云主机和切片集群的两种方式，这两种方式就对应这数据量增多的两种方案：纵向扩展和横向扩展。
> 纵向扩展的好处显而易见是实施起来简单、直接。但是也面临着两个潜在的问题：第一个问题：硬件和成本的限制。第二个问题：RDB对数据化进行持久化时，主线程fock子线程时可能会阻塞。


## 数据切片和实例的对应分布关系
从 3.0 开始，官方提供了一个名为 Redis Cluster 的方案，用于实现切片集群。Redis Cluster 方案中就规定了数据和实例的对应规则。
具体来说，Redis Cluster 方案采用哈希槽（Hash Slot，接下来我会直接称之为 Slot），来处理数据和实例之间的映射关系。
在 Redis Cluster 方案中，一个切片集群共有 16384 个哈希槽，这些哈希槽类似于数据分区，每个键值对都会根据它的 key，被映射到一个哈希槽中。
具体的映射过程分为两大步：
一：首先根据键值对的 key，按照CRC16 算法计算一个 16 bit 的值；
二：然后，再用这个 16bit 值对 16384 取模，得到 0~16383 范围内的模数，每个模数代表一个相应编号的哈希槽。
### 这些哈希槽又是如何被映射到具体的 Redis 实例上的呢？
我们在部署 Redis Cluster 方案时，可以使用 cluster create 命令创建集群，此时，Redis 会自动把这些槽平均分布在集群实例上。例如，如果集群中有 N 个实例，那么，每个实例上的槽个数为 16384/N 个。
我们也可以使用 cluster meet 命令手动建立实例间的连接，形成集群，再使用 cluster addslots 命令，指定每个实例上的哈希槽个数。

**注意：**在手动分配哈希槽时，需要把 16384 个槽都分配完，否则 Redis 集群无法正常工作。


## 客户端如何定位数据？
客户端和集群实例建立连接后，实例就会把哈希槽的分配信息发给客户端。但是，在集群刚刚创建的时候，每个实例只知道自己被分配了哪些哈希槽，是不知道其他实例拥有的哈希槽信息的。
那么，客户端为什么可以在访问任何一个实例时，都能获得所有的哈希槽信息呢？这是因为，Redis 实例会把自己的哈希槽信息发给和它相连接的其它实例，来完成哈希槽分配信息的扩散。
当实例之间相互连接后，每个实例就有所有哈希槽的映射关系了。客户端收到哈希槽信息后，会把哈希槽信息缓存在本地。当客户端请求键值对时，会先计算键所对应的哈希槽，然后就可以给相应的实例发送请求了。