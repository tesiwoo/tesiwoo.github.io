---
title: 哨兵机制
createTime: 2025/07/04 18:05:59
permalink: /db/reidsSentinelMechanism/
tag:
  - Redis
---
# 哨兵机制

为确保当主库宕机后，Redis集群依旧可以正常提供服务，Redis提供了哨兵机制

主库挂了之后，从库能够提供读操作，但是没有主库就不能为客服端提供写操作，哨兵机制用于 确定主库真的挂了、推举一个从库作为新的主库向外提供写操作等
哨兵负责的三个任务：**监控**，**选择主库**，**通知**

## 哨兵机制的基本流程

**监控：** 
&emsp; 哨兵会周期性给所有主从库发送PING命令，检测Redis服务器是否在线运行。
&emsp; 如果从库在规定时间内响应哨兵的PING命令，哨兵就将它标记为“下线状态”，该从库就不再向外提供读操作。
&emsp; 同样，主库在规定时间内没有响应哨兵的PING命令，哨兵就会判定为主库下线，然后开始  自动切换主库  的流程。

**选主：**
&emsp; 主库挂掉之后，没有在规定时间内响应哨兵的PING命令，哨兵们就会在所有从库中选择一台作为新的主库。 具体流程，在后面

**通知：**
&emsp; 新主库上位后，哨兵会将新主库的连接信息发给其他从库，让它们执行 replicaof 命令，和新主库建立链接，并进行数据复制。 同时，哨兵也会将该信息发给客户端。

## 主库的主观下线和客观下线

主观下线： 如果哨兵发现主库或者从库对PING命令的响应超时了，这个时候 哨兵就会把它标记成“主观下线”
ps:如果检测的是从库，哨兵简单的把它标记成是 主观下线。

如果检测的是主库，哨兵不能直接的将主库标记为主观下线，开启主从切换，因为，有可能是哨兵误判了，其实主库并没有故障，但是启动主从切换会导致额外的计算和通信开销。

为了避免误判的情况，哨兵通常会采用多实例组成的集群模式进行部署，它们被称之为哨兵集群。
当有一个哨兵判断判断主库为下线状态后，会通知其他哨兵也对主库发送PING命令，当大多数哨兵判断为主库为“主观下线”状态后，主库才会被标记为“客观下线状态”。

## 选定新主库
哨兵选择新主库的过程称之为 “筛选+打分” 。 哨兵集群会从多个主库中按照 一定的筛选条件（如：已下线，总是断连） 把不符合条件的从库过滤掉，再通过一定的规则（如：同步速率最快）对剩下的从库进行打
分，然后将得分最高的从库作为新主库。
三轮打分: 从库优先级、重复复制进度、从库ID号。

## 基于pub/sub 机制的哨兵集群

部署哨兵集群只需要设置 **主库的ip**和**端口号**，并没有配置其他哨兵的连接信息。那么那么多哨兵是如何组成集群的呢？
```shell
sentinel monitor <master-name> <ip> <redis-port> <quorum>
```

哨兵之间可以相互发现，是借助与Redis 的发布与订阅机制。
哨兵只要和主库建立起了连接，就可以在主库上发布消息和订阅消息了。
在主从集群中，主库上有一个名为 “_ _sentinel_ _:hello” 的频道，不同哨兵就是通过这个频道来相互发现与通信的。

哨兵获取从库的ip地址和端口的方式是想主库发送INFO命令，主库会将从库列表中返回给哨兵。

## 其他知识点

### 基于 pub/sub 机制的客户端事件通知
客户端可以通过订阅不同的频道，获取不同的订阅信息。如：实例进入**主观下线**频道 **+sdown** ； 退出主观下线 -sdown；进入客观下线 +odown；退出客观下线： -odown；新主库切换： + switch-naster 等
### 哨兵选举
当发生主库切换的事件时，选择那个哨兵进行主从切换的机制。通过投票的方式来选举，一个哨兵只能选一个哨兵头头，时间优先，少数服从多数

